<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>..\js\assets\controllers\querier\querierPanelCtrl.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/capdfHydrogeochemCtrl.html">capdfHydrogeochemCtrl</a></li>
                                <li><a href="../classes/CapdfWMSService.html">CapdfWMSService</a></li>
                                <li><a href="../classes/collapseInfoPanelCtrl.html">collapseInfoPanelCtrl</a></li>
                                <li><a href="../classes/D3PlotService.html">D3PlotService</a></li>
                                <li><a href="../classes/defaultAnalyticCtrl.html">defaultAnalyticCtrl</a></li>
                                <li><a href="../classes/FilterStateService.html">FilterStateService</a></li>
                                <li><a href="../classes/GetCSWRecordService.html">GetCSWRecordService</a></li>
                                <li><a href="../classes/GetFilterParamService.html">GetFilterParamService</a></li>
                                <li><a href="../classes/GetWFSRelatedService.html">GetWFSRelatedService</a></li>
                                <li><a href="../classes/GetWMSRelatedService.html">GetWMSRelatedService</a></li>
                                <li><a href="../classes/GMLParserService.html">GMLParserService</a></li>
                                <li><a href="../classes/googleMapCtrl.html">googleMapCtrl</a></li>
                                <li><a href="../classes/GoogleMapService.html">GoogleMapService</a></li>
                                <li><a href="../classes/infoPanelCtrl.html">infoPanelCtrl</a></li>
                                <li><a href="../classes/LayerManagerService.html">LayerManagerService</a></li>
                                <li><a href="../classes/layerPanelCtrl.html">layerPanelCtrl</a></li>
                                <li><a href="../classes/layerSearchCtrl.html">layerSearchCtrl</a></li>
                                <li><a href="../classes/loadAnalyticCtrl.html">loadAnalyticCtrl</a></li>
                                <li><a href="../classes/loadFilterCtrl.html">loadFilterCtrl</a></li>
                                <li><a href="../classes/NVCLService.html">NVCLService</a></li>
                                <li><a href="../classes/pressureDbCtrl.html">pressureDbCtrl</a></li>
                                <li><a href="../classes/PreviewMapService.html">PreviewMapService</a></li>
                                <li><a href="../classes/QuerierPanelService.html">QuerierPanelService</a></li>
                                <li><a href="../classes/RenderHandlerService.html">RenderHandlerService</a></li>
                                <li><a href="../classes/RenderStatusService.html">RenderStatusService</a></li>
                                <li><a href="../classes/SimpleXPathService.html">SimpleXPathService</a></li>
                                <li><a href="../classes/StyleService.html">StyleService</a></li>
                                <li><a href="../classes/WFSService.html">WFSService</a></li>
                                <li><a href="../classes/WMS_1_1_0_Service.html">WMS_1_1_0_Service</a></li>
                                <li><a href="../classes/WMS_1_3_0_Service.html">WMS_1_3_0_Service</a></li>
                                <li><a href="../classes/WMSService.html">WMSService</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/analytic.html">analytic</a></li>
                                <li><a href="../modules/controllers.html">controllers</a></li>
                                <li><a href="../modules/http.html">http</a></li>
                                <li><a href="../modules/layer.html">layer</a></li>
                                <li><a href="../modules/map.html">map</a></li>
                                <li><a href="../modules/utility.html">utility</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: ..\js\assets\controllers\querier\querierPanelCtrl.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
 * This class handles rendering of the querier panel
 * @module controllers
 * @class querierPanelCtrl
 *
 */
allControllers.controller(&#x27;querierPanelCtrl&#x27;,  [&#x27;$compile&#x27;, &#x27;$scope&#x27;, &#x27;GoogleMapService&#x27;, &#x27;QuerierPanelService&#x27;, &#x27;SimpleXMLService&#x27;, &#x27;UtilitiesService&#x27;, &#x27;Constants&#x27;, &#x27;$timeout&#x27;,
                                                function ($compile, $scope, GoogleMapService, QuerierPanelService, SimpleXMLService, UtilitiesService, Constants, $timeout) {
    //VT: an array of object
    $scope.treeStruct = {};
    $scope.JSONTreeStruct = [];
    
    // Associative array: key is layer name, values are list of feature names for that layer
    // Used to display the layer name as a header in query panel
    $scope.layerIndex = {};
    
    
    // Turn off carousel
    $scope.useCarousel = false;
    
    // Empty carousel slides
    $scope.slides = [];
    
    // Turn off carousel busy icon
    $scope.carouselBusy = false;
   

    /**
    * Used to initialise the controller.
    * @method init
    * @param xmlPanelId the id of the &lt;div&gt; where the XML accordion tree is to be displayed
    */
    $scope.init = function(xmlPanelId) { 
        $scope.xmlPanelId = xmlPanelId;
        // This registers this class&#x27; functions with the QuerierPanelService
        QuerierPanelService.registerPanel($scope.openPanel, $scope.addPanelTree, $scope.setCarouselImages, $scope.setCarouselBusy);
        GoogleMapService.onLayerRemoved($scope, function(evt,layer){ QuerierPanelService.deregisterLayer(layer) });
    };
        
    /**
    * @method resetTree
    * @param panelStatus  status of panel, if closed is false, if open is true
    */    
    $scope.resetTree = function(panelStatus) {
        if (!panelStatus) {
            $scope.treeStruct={};
            $scope.JSONTreeStruct = [];
            $scope.layerIndex = {};
        }
    };
    
    /**
    * Used to display XML in tree form in the panel, calls parse() function
    * Passed to &#x27;QuerierPanelService&#x27; as a parameter, then called by &#x27;QuerierPanelService&#x27;
    * It is possible for node to be passed in as a feature node or the whole collection. We attempt to be smart
    * by assuming it is a feature collection and if it fails, we assume it to be a feature node.
    * @method addPanelTree
    * @param xmlString string which will be displayed
    * @param displayName name of layer or feature, to be used only if no suitable name is found within XML string
    * @param appendFlag will append the new tree to the current tree(s) on panel or clear the panel and add a new tree
    * @return boolean value, true if the panel should be opened because there is something to display
    */
    $scope.addPanelTree = function(node, displayName, prependStr, appendFlag) {
        
        var displayable = false;
        
        // Clear the panel
        if (!appendFlag) {
            $scope.resetTree(false);
            $scope.resetCarousel(false);
        }
        if (node) {
            // First try to find any &quot;FeatureCollection&quot; elements 
            // If it not found, and no error report was found, we assume the node to be a feature node.
            var rootNode = node;            
            var wfsFeatureCollection = SimpleXMLService.getMatchingChildNodes(rootNode, null, &quot;FeatureCollection&quot;);
            var features = null;
            if (UtilitiesService.isEmpty(wfsFeatureCollection)) {
                // Check for error reports - some WMS servers mark their error reports with &lt;ServiceExceptionReport&gt;, some with &lt;html&gt; 
                var exceptionNode = SimpleXMLService.getMatchingChildNodes(rootNode, null, &quot;ServiceExceptionReport&quot;);
                var serviceErrorNode = SimpleXMLService.evaluateXPath(rootNode, rootNode, &quot;html&quot;, Constants.XPATH_UNORDERED_NODE_ITERATOR_TYPE);
                var nextNode=serviceErrorNode.iterateNext();
                if (!UtilitiesService.isEmpty(exceptionNode) || nextNode!=null) {
                    // There is an error report from the server
                    var errorStr = &quot;Sorry - server has returned an error message.&quot;;
                    var displayStr = prependStr+&quot; &quot;+displayName;
                    $scope.treeStruct[errorStr] = document.createTextNode(&quot;See browser console for more information&quot;);
                    if (displayName in $scope.layerIndex) {
                        if ($scope.layerIndex[displayStr].indexOf(errorStr)&lt;0) $scope.layerIndex[displayStr].push(errorStr);
                    } else {                            
                        $scope.layerIndex[displayStr] = [errorStr]; 
                    }
                    console.error(&quot;querierPanelCtrl.addPanelTree(): Server returned error&quot;, rootNode);
                    return true;
                }
                var featureInfoNode = SimpleXMLService.getMatchingChildNodes(rootNode, null, &quot;FeatureInfoResponse&quot;);
                if (UtilitiesService.isEmpty(featureInfoNode)) {
                    // Assume the node to be a feature node. 
                    features = [node];
                } else {
                    // ArcGIS special format - not standard XML. Must use the passed-in display name.
                    var fieldNodes = SimpleXMLService.getMatchingChildNodes(featureInfoNode[0], null, &quot;FIELDS&quot;);
                    features = fieldNodes;
                    for (var i = 0; i &lt; features.length; i++) {
                        var name = features[i].getAttribute(&#x27;identifier&#x27;);
                        $scope.treeStruct[name] = features[i];
                        var displayStr = prependStr+&quot; &quot;+displayName;
                        if (displayName in $scope.layerIndex) {
                            if ($scope.layerIndex[displayStr].indexOf(name)&lt;0) $scope.layerIndex[displayStr].push(name);
                        } else {                            
                            $scope.layerIndex[displayStr] = [name]; 
                        }
                        displayable=true;
                    }
                    return displayable;
                }

            } else {
                // Read through our wfs:FeatureCollection and gml:featureMember(s) elements 
                var featureMembers = SimpleXMLService.getMatchingChildNodes(wfsFeatureCollection[0], null, &quot;featureMembers&quot;);                 
                if (UtilitiesService.isEmpty(featureMembers)) {
                    featureMembers = SimpleXMLService.getMatchingChildNodes(wfsFeatureCollection[0], null, &quot;featureMember&quot;);
                    features = featureMembers;
                } else {
                    features = featureMembers[0].childNodes;
                }
            }
            for (var i = 0; i &lt; features.length; i++) {
                // Pull out some general stuff that we expect all features to have
                var featureNode = features[i];
                var name = featureNode.getAttribute(&#x27;gml:id&#x27;);
                if (UtilitiesService.isEmpty(name)) {
                    name = SimpleXMLService.evaluateXPath(rootNode, featureNode, &quot;gml:name&quot;, Constants.XPATH_STRING_TYPE).stringValue;
                }
                if (typeof name === &#x27;string&#x27; || name.length &gt; 0) {
                    $scope.treeStruct[name] = featureNode;
                    var localName = prependStr+&quot; &quot;+$scope.treeStruct[name].localName;
                    if (localName in $scope.layerIndex) {
                        if ($scope.layerIndex[localName].indexOf(name)&lt;0) $scope.layerIndex[localName].push(name);
                    } else {
                        $scope.layerIndex[localName] = [name]; 
                    }
                    displayable = true;
                }
            }
        }
        return displayable;
    };
    
    /**
    * This is called from the Angular HTML template. It parses the XML tree,
    * creating a JSON representation which is passed in to create a tree view
    * via the &quot;$scope.JSONTreeStruct[]&quot; array
    *
    * @method parseTree
    * @param name - a label displayed at the top of the tree
    */
    $scope.parseTree = function(name){
        
        if($scope.JSONTreeStruct[name]){
            return;
        }
       
        var value=[];
        
        var parseNodeToJson = function(node,tier,child){
            var attrArr = SimpleXMLService.getMatchingAttributes(node);
            var attrChildren = [];
            if (attrArr) {
                for (var i=0; i&lt; attrArr.length; i++) {
                    if (attrArr[i].name &amp;&amp; attrArr[i].value)
                        attrChildren.push({label: attrArr[i].name+&quot;: &quot;+attrArr[i].value, children : []});
                }
            }
            if (SimpleXMLService.isLeafNode(node)) {
                
                return ({
                    label : SimpleXMLService.getNodeLocalName(node),
                    id:&#x27;id&#x27;+tier+child,
                    children : [{
                        label : SimpleXMLService.getNodeTextContent(node),
                        id:&#x27;id&#x27;+(tier+1)+child,
                        children : attrChildren     
                    }]                    
                });
               
            }else{
                var collapsed = true;
                if(tier &lt;= 1){
                    collapsed = false;
                }
                var nodeObj={
                        label : SimpleXMLService.getNodeLocalName(node),
                        id:&#x27;id&#x27; + tier,
                        collapsed:collapsed,
                        children : attrChildren                    
                };
                
                var child = SimpleXMLService.getMatchingChildNodes(node); 
                for(var i = 0; i&lt; child.length;i++){
                    nodeObj.children.push(parseNodeToJson(child[i],tier+1,i));
                }                
                return nodeObj
            }  
            
        };
        value.push(parseNodeToJson($scope.treeStruct[name],0,0));
        
        $timeout(function() {           
            $scope.JSONTreeStruct[name] = value;
        },0);

    };
    
    /**
    * Used to open and close the panel. 
    * Passed to &#x27;QuerierPanelService&#x27; as a parameter, then called by &#x27;QuerierPanelService&#x27;
    * @method openPanel 
    * @param ctrlBool if true panel will open, if false panel will close
    * @param useApply will call $apply() on $parent object if set to true
    */
    $scope.openPanel = function(ctrlBool, useApply) {
        $scope.$parent.showQuerierPanel = ctrlBool;
        if (useApply)
            $scope.$parent.$apply();
    };
    
    
    /**
    * Sets the images for the carousel
    * @method setCarouselImages
    * @param imageList
    */
    $scope.setCarouselImages = function(imageList) {
        // Must do a reset, then set the image list, to force slick to initialise, else AngularJS crashes
        $timeout(function() {
            // Do a reset
            $scope.useCarousel = false;
            $scope.slides = [];
            return $timeout(function() {
                // Set the image list            
                $scope.slides = imageList;
                $scope.useCarousel = true;
            },0);
        });
        
    }
    
    /**
    * Resets the carousel when the panel closes
    * @method resetCarousel
    * @param panelStatus open/closed status of the querier panel
    */
    $scope.resetCarousel = function(panelStatus) {
        if (!panelStatus) {
            $scope.useCarousel = false;
            $scope.slides = [];
        }
    }
    
    /**
    * Controls the display of the spinner to let user know the carousel is loading
    * @method setCarouselBusy
    * @param busyFlag set to true to make the spinner display, else false ot make it go away
    */
    $scope.setCarouselBusy = function(busyFlag) {
        $scope.carouselBusy = busyFlag;
    }
    
}]);
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
