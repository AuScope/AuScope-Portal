<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>..\js\assets\modules\service\layer\renderers\wms\WMSService.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/capdfHydrogeochemCtrl.html">capdfHydrogeochemCtrl</a></li>
                                <li><a href="../classes/CapdfWMSService.html">CapdfWMSService</a></li>
                                <li><a href="../classes/collapseInfoPanelCtrl.html">collapseInfoPanelCtrl</a></li>
                                <li><a href="../classes/D3PlotService.html">D3PlotService</a></li>
                                <li><a href="../classes/defaultAnalyticCtrl.html">defaultAnalyticCtrl</a></li>
                                <li><a href="../classes/FilterStateService.html">FilterStateService</a></li>
                                <li><a href="../classes/GetCSWRecordService.html">GetCSWRecordService</a></li>
                                <li><a href="../classes/GetFilterParamService.html">GetFilterParamService</a></li>
                                <li><a href="../classes/GetWFSRelatedService.html">GetWFSRelatedService</a></li>
                                <li><a href="../classes/GetWMSRelatedService.html">GetWMSRelatedService</a></li>
                                <li><a href="../classes/GMLParserService.html">GMLParserService</a></li>
                                <li><a href="../classes/googleMapCtrl.html">googleMapCtrl</a></li>
                                <li><a href="../classes/GoogleMapService.html">GoogleMapService</a></li>
                                <li><a href="../classes/infoPanelCtrl.html">infoPanelCtrl</a></li>
                                <li><a href="../classes/LayerManagerService.html">LayerManagerService</a></li>
                                <li><a href="../classes/layerPanelCtrl.html">layerPanelCtrl</a></li>
                                <li><a href="../classes/layerSearchCtrl.html">layerSearchCtrl</a></li>
                                <li><a href="../classes/loadAnalyticCtrl.html">loadAnalyticCtrl</a></li>
                                <li><a href="../classes/loadFilterCtrl.html">loadFilterCtrl</a></li>
                                <li><a href="../classes/NVCLService.html">NVCLService</a></li>
                                <li><a href="../classes/pressureDbCtrl.html">pressureDbCtrl</a></li>
                                <li><a href="../classes/PreviewMapService.html">PreviewMapService</a></li>
                                <li><a href="../classes/QuerierPanelService.html">QuerierPanelService</a></li>
                                <li><a href="../classes/RenderHandlerService.html">RenderHandlerService</a></li>
                                <li><a href="../classes/RenderStatusService.html">RenderStatusService</a></li>
                                <li><a href="../classes/SimpleXPathService.html">SimpleXPathService</a></li>
                                <li><a href="../classes/StyleService.html">StyleService</a></li>
                                <li><a href="../classes/WFSService.html">WFSService</a></li>
                                <li><a href="../classes/WMS_1_1_0_Service.html">WMS_1_1_0_Service</a></li>
                                <li><a href="../classes/WMS_1_3_0_Service.html">WMS_1_3_0_Service</a></li>
                                <li><a href="../classes/WMSService.html">WMSService</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/analytic.html">analytic</a></li>
                                <li><a href="../modules/controllers.html">controllers</a></li>
                                <li><a href="../modules/http.html">http</a></li>
                                <li><a href="../modules/layer.html">layer</a></li>
                                <li><a href="../modules/map.html">map</a></li>
                                <li><a href="../modules/utility.html">utility</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: ..\js\assets\modules\service\layer\renderers\wms\WMSService.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * WMSService handles rendering of all wms layers onto the map
 * @module map
 * @class WMSService
 * 
 */
allModules.service(&#x27;WMSService&#x27;,[&#x27;$interval&#x27;,&#x27;GoogleMapService&#x27;,&#x27;LayerManagerService&#x27;,&#x27;Constants&#x27;,&#x27;GetWMSRelatedService&#x27;,&#x27;RenderStatusService&#x27;,&#x27;QuerierPanelService&#x27;,&#x27;WMS_1_1_0_Service&#x27;,&#x27;WMS_1_3_0_Service&#x27;,&#x27;UtilitiesService&#x27;,
                                 function ($interval,GoogleMapService,LayerManagerService,Constants,GetWMSRelatedService,RenderStatusService,QuerierPanelService,WMS_1_1_0_Service,WMS_1_3_0_Service,UtilitiesService) {
    
    var maxSldLength = 1900;
    var LAYERCHK_INT = 1000; // Check layer loading progress this often (millisecond)
    var LAYERCHK_NUM = 45; // Check layer loading progress this many times
    
    this.tiles = {};
    this.timers = {};
    var me = this;
    

   
    
    /**
     * Look for img elements and add event handlers to them or timeout
     * @method evaluateTiles
     * @param layer layer object
     * @param onlineResource online resource object
     * @param tilesLoaded is this being called after a &#x27;tilesloaded&#x27; event?
     * @return true if the timer should be cancelled
     */
    this.evaluateTiles = function(layer, onlineResource, tilesLoaded) {
        
        // Is Internet Explorer?
        var msie = document.documentMode;
        var cancelTimer = false;
        
        var reportError = function(e) {
            RenderStatusService.updateCompleteStatus(layer,onlineResource,Constants.statusProgress.ERROR);
        };
    
        var reportCompleted = function(e) {
            RenderStatusService.updateCompleteStatus(layer,onlineResource,Constants.statusProgress.COMPLETED);
        };
        
        // Look for one good tile in the mapLayer
        for (var t=0; t&lt;me.tiles[layer.id][onlineResource.url].length; t++) {
            var imgNode = $(&quot;img&quot;, me.tiles[layer.id][onlineResource.url][t].node).get(0);
            // *IF* there is an image element then decide as best we can or put some event handlers on it 
            if (imgNode) {         
                // BEWARE! This does not always indicate that the image is visible.
                // The image will be visible once the &lt;div&gt; is added to the map.
                // On IE and Chrome this means that the layers may not appear until the last layer has loaded.
                if (imgNode.complete &amp;&amp; (msie || (imgNode.currentSrc &amp;&amp; imgNode.currentSrc==imgNode.src)) &amp;&amp; imgNode.naturalWidth==Constants.TILE_SIZE &amp;&amp; imgNode.naturalHeight==Constants.TILE_SIZE) {
                    reportCompleted();
                    cancelTimer = true;
                    break;
                }
                // If service returns a text error message instead of an image
                if (imgNode.complete &amp;&amp; (imgNode.naturalWidth==0 || imgNode.naturalHeight==0)) {
                    reportError();
                    cancelTimer = true;
                    break;
                }
                // These will only work for slower connections and slower browsers (Firefox) where &lt;img&gt; has been created, but image data has not been received
                if (!me.tiles[layer.id][onlineResource.url][t].hasEvents &amp;&amp; $(&quot;img&quot;, me.tiles[layer.id][onlineResource.url][t].node).length&gt;0) {                    
                    $(&quot;img&quot;, me.tiles[layer.id][onlineResource.url][t].node).one(&quot;error&quot;, reportError);
                    $(&quot;img&quot;, me.tiles[layer.id][onlineResource.url][t].node).one(&quot;load&quot;, reportCompleted);
                    me.tiles[layer.id][onlineResource.url][t].hasEvents = true;
                }
            }
        }
        return cancelTimer;
    };
    
    /**
     * Add layer to Google Map
     * @method addLayerToGoogleMap
     * @param mapLayer Google mapLayer object
     * @param layer layer object
     * @param onlineResource online resource object
     * @param style map style
     */
    var addLayerToGoogleMap = function(mapLayer,layer,onlineResource,style){
        
        var map = GoogleMapService.getMap();
        
        // NB: Google Maps &#x27;tilesloaded&#x27; event is not reliable. 
        // Often it is triggered when the layer is loaded but image is not yet rendered or even when the browser is still waiting for image data
        var registerTileLoadedEvent = function(mapLayer, layer, onlineResource) {

            // Set up storage for tile nodes
            if (!(layer.id in me.tiles)) me.tiles[layer.id] = {};
            me.tiles[layer.id][onlineResource.url] = [];
            
            // Remove old interval timer and set up a new one
            if (!(layer.id in me.timers)) me.timers[layer.id] = {};
            if (onlineResource.url in me.timers[layer.id] &amp;&amp; me.timers[layer.id][onlineResource.url]) {
                $interval.cancel(me.timers[layer.id][onlineResource.url].promise);
            }
            // Setup a timer function to monitor the loading process
            me.timers[layer.id][onlineResource.url] = { 
                cnt: 0, // Number of timer function iterations
                promise: $interval( // Timer function
            
                function(mapLayer, layer,onlineResource) {
                    me.timers[layer.id][onlineResource.url].cnt++;
                    // If still RUNNING ...
                    if (RenderStatusService.checkStatus(layer,onlineResource,Constants.statusProgress.RUNNING)) {
                        // And tiles still loading and not last timer iteration then exit
                        if (!me.evaluateTiles(layer, onlineResource) &amp;&amp; (me.timers[layer.id][onlineResource.url].cnt &lt; LAYERCHK_NUM)) {
                            return;
                        }
                        // If this is the final iteration then signal a timeout with an error
                        if (me.timers[layer.id][onlineResource.url].cnt &gt;= LAYERCHK_NUM) {
                            RenderStatusService.updateCompleteStatus(layer,onlineResource,Constants.statusProgress.ERROR);
                        }
                    }
                    
                    // Cancel timer
                    if (me.timers[layer.id][onlineResource.url].promise)
                        $interval.cancel(me.timers[layer.id][onlineResource.url].promise);
                    me.timers[layer.id][onlineResource.url] = null;
                    
                    // Reset tiles
                    me.tiles[layer.id][onlineResource.url] = [];

                }, LAYERCHK_INT, LAYERCHK_NUM, true, mapLayer, layer, onlineResource)
            };
        };
        
        /**
         * Hack to override the getTile function to gain access to the underlying tile &lt;div&gt;s to monitor progress of layer loading
         * Note that &#x27;getTile&#x27; is also called every time the map pans, resizes etc.
         */
        var overrideToRegisterFailureEvent = function(mapLayer){
            
            mapLayer.imagelayerGetTile = mapLayer.getTile;
            mapLayer.getTile = function(tileCoord, zoom, ownerDocument){
                // Call Google Map&#x27;s &#x27;getTile&#x27;
                var node = mapLayer.imagelayerGetTile(tileCoord, zoom, ownerDocument);
                
                // Save tile nodes in order to check if the layer is loading correctly
                // Only sample the first 10 tiles
                if (me.tiles[layer.id][onlineResource.url].length &lt; 10) {
                    me.tiles[layer.id][onlineResource.url].push({node: node, hasEvents: false});
                }
                return node;
            };
            return mapLayer;
        };
        
        // Setup interval timer to monitor layer loading process
        registerTileLoadedEvent(mapLayer,layer,onlineResource);
        
        // Get the bounding box for the &#x27;onlineResource&#x27;, then register for click events within that bounding box
        var cswRecords = LayerManagerService.getCSWRecords(layer);
        var done = false;
        for (var i=0; i&lt;cswRecords.length &amp;&amp; !done; i++) {
            var onlineResources = cswRecords[i].onlineResources;
            for (var j=0; j&lt;onlineResources.length; j++) {
                if (onlineResource==onlineResources[j]) {
                    var bbox = cswRecords[i].geographicElements[0];
                    // ArcGIS servers do not accept styles
                    if (onlineResources[j].applicationProfile &amp;&amp; onlineResources[j].applicationProfile.indexOf(&quot;Esri:ArcGIS Server&quot;) &gt; -1) {
                        QuerierPanelService.registerLayer(map, onlineResource, bbox, &quot;&quot;);
                    } else {
                        QuerierPanelService.registerLayer(map, onlineResource, bbox, style);
                    }
                    done = true;
                    break;
                }
            }
        }
        
        // Overrides Google Map API to register event handler
        mapLayer = overrideToRegisterFailureEvent(mapLayer, layer.id);

        // This adds the layer to Google Map
        map.overlayMapTypes.push(mapLayer);
        
        // This keeps track of our layers
        GoogleMapService.addLayerToActive(layer,mapLayer);       
       
    };
   
 
    /**
     * Method to decide how the wms should be rendered and add the wms to the map 
     * @method renderLayer
     * @param layer - The layer containing the wms to be rendered
     * @param param - OPTIONAL - parameter to be passed into retrieving the SLD. 
     * 
     */
    this.renderLayer = function(layer,param){   

        var me = this;
        if(!param){
            param = {};
        }
        var onlineResources = LayerManagerService.getWMS(layer);            
        RenderStatusService.setMaxValue(layer,UtilitiesService.uniqueCountOfResourceByUrl(onlineResources));
        for(var index in onlineResources){ 
            if(UtilitiesService.filterProviderSkip(param.optionalFilters, onlineResources[index].url)){
                RenderStatusService.updateCompleteStatus(layer,onlineResources[index],Constants.statusProgress.SKIPPED);
                continue;
            }
            RenderStatusService.updateCompleteStatus(layer,onlineResources[index],Constants.statusProgress.RUNNING);
            GetWMSRelatedService.getWMSStyle(layer,onlineResources[index],param).then(function(response){
                try{
                    var useSldUrl = false;
                    if(response.style!=null &amp;&amp; encodeURIComponent(response.style).length&gt;maxSldLength){
                        useSldUrl = true;
                    }  
                    
                    if(response.onlineResource.version === Constants.WMSVersion[&#x27;1.1.1&#x27;] || response.onlineResource.version === Constants.WMSVersion[&#x27;1.1.0&#x27;]){                                                                        
                        var mapLayer = WMS_1_1_0_Service.generateLayer(response.onlineResource,response.style,useSldUrl?GetWMSRelatedService.getWMSStyleUrl(layer,response.onlineResource,param):null);                                                
                        addLayerToGoogleMap(mapLayer,layer,response.onlineResource,response.style);                    
                    }else if(response.onlineResource.version === Constants.WMSVersion[&#x27;1.3.0&#x27;]){
                        var mapLayer = WMS_1_3_0_Service.generateLayer(response.onlineResource,response.style,useSldUrl?GetWMSRelatedService.getWMSStyleUrl(layer,response.onlineResource,param):null); 
                        addLayerToGoogleMap(mapLayer,layer,response.onlineResource,response.style); 
                        
                    } 
                }catch(err){
                    RenderStatusService.updateCompleteStatus(layer,response.onlineResource,Constants.statusProgress.ERROR);
                }
            },function(error){
                RenderStatusService.updateCompleteStatus(layer,error.onlineResource,Constants.statusProgress.ERROR);
            });
        }
       
  
    };
    
    
    
    
    
    /**
     * Method to decide how the wms csw record should be rendered and add the wms to the map 
     * @method renderCSWRecord
     * @param layer - The layer containing the wms to be rendered
     * @param cswRecord - The cswRecord containing the wms to be rendered
     */
    this.renderCSWRecord = function(layer,cswRecord){         
        var me = this;
        
            var onlineResources = LayerManagerService.getWMSFromCSW(cswRecord);            
            RenderStatusService.setMaxValue(layer,UtilitiesService.uniqueCountOfResourceByUrl(onlineResources));
            for(var index in onlineResources){  
                RenderStatusService.updateCompleteStatus(layer,onlineResources[index],Constants.statusProgress.RUNNING);
                GetWMSRelatedService.getWMSStyle(layer,onlineResources[index]).then(function(response){
                    try{
                        var useSldUrl = false;
                        if(response.style!=null &amp;&amp; response.style.length&gt;maxSldLength){
                            useSldUrl = true;
                        } 
                        if(response.onlineResource.version === Constants.WMSVersion[&#x27;1.1.1&#x27;] || response.onlineResource.version === Constants.WMSVersion[&#x27;1.1.0&#x27;]){
                            var mapLayer = WMS_1_1_0_Service.generateLayer(response.onlineResource,response.style,useSldUrl?GetWMSRelatedService.getWMSStyleUrl(layer,response.onlineResource,null):null);                        
                            addLayerToGoogleMap(mapLayer,layer,response.onlineResource);                  
                        }else if(response.onlineResource.version === Constants.WMSVersion[&#x27;1.3.0&#x27;]){
                            var mapLayer = WMS_1_3_0_Service.generateLayer(response.onlineResource,response.style,useSldUrl?GetWMSRelatedService.getWMSStyleUrl(layer,response.onlineResource,null):null); 
                            addLayerToGoogleMap(mapLayer,layer,response.onlineResource);  
                        } 
                    }catch(err){
                        RenderStatusService.updateCompleteStatus(layer,response.onlineResource,Constants.statusProgress.ERROR);
                    }
                },function(error){
                    RenderStatusService.updateCompleteStatus(layer,error.onlineResource,Constants.statusProgress.ERROR);
                });
            }
        
  
    };
    
     
}]);
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
