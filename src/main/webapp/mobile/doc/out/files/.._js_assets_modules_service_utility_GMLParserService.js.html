<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>..\js\assets\modules\service\utility\GMLParserService.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/capdfHydrogeochemCtrl.html">capdfHydrogeochemCtrl</a></li>
                                <li><a href="../classes/CapdfWMSService.html">CapdfWMSService</a></li>
                                <li><a href="../classes/collapseInfoPanelCtrl.html">collapseInfoPanelCtrl</a></li>
                                <li><a href="../classes/D3PlotService.html">D3PlotService</a></li>
                                <li><a href="../classes/defaultAnalyticCtrl.html">defaultAnalyticCtrl</a></li>
                                <li><a href="../classes/FilterStateService.html">FilterStateService</a></li>
                                <li><a href="../classes/GetCSWRecordService.html">GetCSWRecordService</a></li>
                                <li><a href="../classes/GetFilterParamService.html">GetFilterParamService</a></li>
                                <li><a href="../classes/GetWFSRelatedService.html">GetWFSRelatedService</a></li>
                                <li><a href="../classes/GetWMSRelatedService.html">GetWMSRelatedService</a></li>
                                <li><a href="../classes/GMLParserService.html">GMLParserService</a></li>
                                <li><a href="../classes/googleMapCtrl.html">googleMapCtrl</a></li>
                                <li><a href="../classes/GoogleMapService.html">GoogleMapService</a></li>
                                <li><a href="../classes/infoPanelCtrl.html">infoPanelCtrl</a></li>
                                <li><a href="../classes/LayerManagerService.html">LayerManagerService</a></li>
                                <li><a href="../classes/layerPanelCtrl.html">layerPanelCtrl</a></li>
                                <li><a href="../classes/layerSearchCtrl.html">layerSearchCtrl</a></li>
                                <li><a href="../classes/loadAnalyticCtrl.html">loadAnalyticCtrl</a></li>
                                <li><a href="../classes/loadFilterCtrl.html">loadFilterCtrl</a></li>
                                <li><a href="../classes/NVCLService.html">NVCLService</a></li>
                                <li><a href="../classes/pressureDbCtrl.html">pressureDbCtrl</a></li>
                                <li><a href="../classes/PreviewMapService.html">PreviewMapService</a></li>
                                <li><a href="../classes/QuerierPanelService.html">QuerierPanelService</a></li>
                                <li><a href="../classes/RenderHandlerService.html">RenderHandlerService</a></li>
                                <li><a href="../classes/RenderStatusService.html">RenderStatusService</a></li>
                                <li><a href="../classes/SimpleXPathService.html">SimpleXPathService</a></li>
                                <li><a href="../classes/StyleService.html">StyleService</a></li>
                                <li><a href="../classes/WFSService.html">WFSService</a></li>
                                <li><a href="../classes/WMS_1_1_0_Service.html">WMS_1_1_0_Service</a></li>
                                <li><a href="../classes/WMS_1_3_0_Service.html">WMS_1_3_0_Service</a></li>
                                <li><a href="../classes/WMSService.html">WMSService</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/analytic.html">analytic</a></li>
                                <li><a href="../modules/controllers.html">controllers</a></li>
                                <li><a href="../modules/http.html">http</a></li>
                                <li><a href="../modules/layer.html">layer</a></li>
                                <li><a href="../modules/map.html">map</a></li>
                                <li><a href="../modules/utility.html">utility</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: ..\js\assets\modules\service\utility\GMLParserService.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * GMLParserService handles the parsing of GML documents
 * @module utility
 * @class GMLParserService
 * 
 */
allModules.service(&#x27;GMLParserService&#x27;,[&#x27;$rootScope&#x27;,&#x27;SimpleXMLService&#x27;,&#x27;UtilitiesService&#x27;,&#x27;Constants&#x27;,function ($rootScope,SimpleXMLService,UtilitiesService,Constants) {
   
    /**
     * Get rootnode from a gml string
     * 
     * @method getRootNode
     * @param gml - GML String
     * @return dom - the root node
     */
    this.getRootNode = function(gml) {
        return SimpleXMLService.parseStringToDOM(gml);               
    },
    
    /**
     * create a point object
     * 
     * @method createPoint
     * @param lat - latitude
     * @param lon - longtitude
     * @return point - point object
     */
    this.createPoint = function(lat,lon){
        return {
            lat : lat,
            lng : lon
        };
    };

    //Given a series of space seperated tuples, return a list of object
    /**
     * Create line string objects in a array
     * @method generateCoordList
     * @param coordsAsString - The coordinates in a string from the feature gml
     * @param srsName - the srs of the feature
     * @return array - an array of points
     */
    this.generateCoordList = function(coordsAsString, srsName) {
        var coordinateList = coordsAsString.split(&#x27; &#x27;);
        var parsedCoordList = [];
        
        for (var i = 0; i &lt; coordinateList.length; i+=2) {
            this.forceLonLat(coordinateList, srsName, i);

            parsedCoordList.push(this.createPoint(parseFloat(coordinateList[i + 1]),parseFloat(coordinateList[i])));
        }

        return parsedCoordList;
    },
    
    /**
     * Get the srs name
     * 
     * @method getSrsName
     * @param node - coordinate node
     * @return string - srs name
     */
    this.getSrsName = function(node) {
        var srsName = node.getAttribute(&quot;srsName&quot;);
        if (UtilitiesService.isEmpty(srsName)) {
            srsName = node.getAttribute(&quot;srs&quot;);
        }
        
        if (!srsName) {
            return &#x27;&#x27;;
        }
        
        return srsName;
    },
    
    /**
     * Forces lon/lat coords into coords (an array). Swaps coords[offset] and coords[offset + 1] if srsName requires it
     * @method forceLonLat
     * @param coords - the coordinates
     * @param srsName - the srs
     * @param offset - offset the coord if required.
     * 
     */
    this.forceLonLat = function(coords, srsName, offset) {
        if (!offset) {
            offset = 0;
        }
        
        if (srsName.indexOf(&#x27;http://www.opengis.net/gml/srs/epsg.xml#4283&#x27;) == 0 || 
            srsName.indexOf(&#x27;urn:x-ogc:def:crs:EPSG&#x27;) == 0) {
            //lat/lon
            var tmp = coords[offset];
            coords[offset] = coords[offset + 1];
            coords[offset + 1] = tmp;
        } else if (srsName.indexOf(&#x27;EPSG&#x27;) == 0 ||
                   srsName.indexOf(&#x27;http://www.opengis.net/gml/srs/epsg.xml&#x27;) == 0) {
            //lon/lat (no action required)
        } else {
            //fallback to lon/lat
        }
    },

    /**
     * Create line string objects in a array
     * @method parseLineString
     * @param name - the name of the feature
     * @param description - description of the feature
     * @param lineStringNode - the coordinate node containing the linestring
     * @return array - an array of points
     */
    this.parseLineString = function(name, description,lineStringNode,featureNode) {
        var srsName = this.getSrsName(lineStringNode);
        var parsedCoordList = this.generateCoordList(SimpleXMLService.getNodeTextContent(lineStringNode.getElementsByTagNameNS(&quot;*&quot;, &quot;posList&quot;)[0]), srsName);
        if (parsedCoordList.length === 0) {
            return null;
        }

        //I&#x27;ve seen a few lines come in with start/end points being EXACTLY the same with no other points. These can be ignored
        if (parsedCoordList.length === 2) {
            if (parsedCoordList[0].longitude === parsedCoordList[1].longitude &amp;&amp;
                parsedCoordList[0].latitude === parsedCoordList[1].latitude) {
                return null;
            }
        }
        
        return {
            name : name,
            description: description,
            srsName:srsName,
            coords: parsedCoordList,
            geometryType : Constants.geometry.LINESTRING,
            featureNode:featureNode
        };
    },


    /**
     * Given a root placemark node attempt to parse it as a single point and return it. Returns a single portal.map.primitives.Polygon
     * @method parsePolygon
     * @param name - the name of the feature
     * @param description - description of the feature
     * @param polygonNode - the coordinate node containing the polygonNode
     * @return array - an array of points
     */
    this.parsePolygon = function(name, description,polygonNode,featureNode) {
        var srsName = this.getSrsName(polygonNode);
        var parsedCoordList = this.generateCoordList(SimpleXMLService.getNodeTextContent(polygonNode.getElementsByTagNameNS(&quot;*&quot;, &quot;posList&quot;)[0]), srsName);
        if (parsedCoordList.length === 0) {
            return null;
        }
        
        //I&#x27;ve seen a few lines come in with start/end points being EXACTLY the same with no other points. These can be ignored
        if (parsedCoordList.length === 2) {
            if (parsedCoordList[0].longitude === parsedCoordList[1].longitude &amp;&amp;
                parsedCoordList[0].latitude === parsedCoordList[1].latitude) {
                return null;
            }
        }

        return {
            name : name,
            description: description,
            srsName:srsName,
            coords: parsedCoordList,
            geometryType : Constants.geometry.POLYGON,
            featureNode:featureNode
        };
            
        
    },

    
    /**
     * Given a root placemark node attempt to parse it as a single point and return it.Returns a single portal.map.primitives.Marker
     * @method parsePoint
     * @param name - the name of the feature
     * @param description - description of the feature
     * @param pointNode - the coordinate node containing the pointNode
     * @param featureNode - the featureNode of the feature we are parsing
     * @return point - a point
     */
    this.parsePoint = function(name, description,pointNode,featureNode) {
        var rawPoints = SimpleXMLService.getNodeTextContent(pointNode.getElementsByTagNameNS(&quot;*&quot;, &quot;pos&quot;)[0]);
        var coordinates = rawPoints.split(&#x27; &#x27;);
        if (!coordinates || coordinates.length &lt; 2) {
            return null;
        }
        
        //Workout whether we are lat/lon or lon/lat
        var srsName = this.getSrsName(pointNode);
        this.forceLonLat(coordinates, srsName);

        var lon = coordinates[0];
        var lat = coordinates[1];
        var point = this.createPoint(parseFloat(lat), parseFloat(lon));
        
        return {
            name : name,
            description: description,
            srsName:srsName,
            coords: point,
            geometryType : Constants.geometryType.POINT,
            featureNode:featureNode
        };
            
       
    },

    /**
     * Returns the feature count as reported by the WFS response. Returns null if the count cannot be parsed.
     * @method getFeatureCount
     * @param rootNode - rootNode
     * @return Number - the feature count
     */
    this.getFeatureCount = function(rootNode) {
        var wfsFeatureCollection = SimpleXMLService.getMatchingChildNodes(rootNode, null, &quot;FeatureCollection&quot;);
        if (UtilitiesService.isEmpty(wfsFeatureCollection)) {
            return null;
        }
        
        var count = parseInt(wfsFeatureCollection[0].getAttribute(&#x27;numberOfFeatures&#x27;));
        if (UtilitiesService.isNumber(count)) {
            return count;
        }
        
        return null;
    },
    
    /**
     * Top level function  that organize how the gml should be parsed
     * @method makePrimitives
     * @param rootNode - the root node of the gml
     * @return Array - can be anything from a single point to a array for polygons and line string:{
            name : name,
            description: description,
            srsName:srsName,
            coords: point,
            geometryType : Constants.geometryType.POINT
        }
     */
    this.makePrimitives = function(rootNode) {
        var primitives = [];
        var wfsFeatureCollection = SimpleXMLService.getMatchingChildNodes(rootNode, null, &quot;FeatureCollection&quot;);
        var features = null;
        //Read through our wfs:FeatureCollection and gml:featureMember(s) elements
        if (UtilitiesService.isEmpty(wfsFeatureCollection)) {
            return primitives;
        }
        var featureMembers = SimpleXMLService.getMatchingChildNodes(wfsFeatureCollection[0], null, &quot;featureMembers&quot;);        
        if (UtilitiesService.isEmpty(featureMembers)) {
            featureMembers = SimpleXMLService.getMatchingChildNodes(wfsFeatureCollection[0], null, &quot;featureMember&quot;);
            features = featureMembers;
        }else{
            features = featureMembers[0].childNodes;
        }
        if (UtilitiesService.isEmpty(featureMembers)) {
            return primitives;
        }
        
        
        for(var i = 0; i &lt; features.length; i++) {
            //Pull out some general stuff that we expect all features to have
            var featureNode = features[i]; 
            var name = featureNode.getAttribute(&#x27;gml:id&#x27;);
            var description = SimpleXMLService.evaluateXPath(rootNode, featureNode, &quot;gml:description&quot;, Constants.XPATH_STRING_TYPE).stringValue;
            if (UtilitiesService.isEmpty(description)) {
                description = SimpleXMLService.evaluateXPath(rootNode, featureNode, &quot;gml:name&quot;, Constants.XPATH_STRING_TYPE).stringValue;
                if (UtilitiesService.isEmpty(description)) {
                    description = name; //resort to gml ID if we have to
                }
            }
            
            //Look for geometry under this feature
            var pointNodes = featureNode.getElementsByTagNameNS(&quot;*&quot;, &quot;Point&quot;);
            var polygonNodes = featureNode.getElementsByTagNameNS(&quot;*&quot;, &quot;Polygon&quot;);
            var lineStringNodes = featureNode.getElementsByTagNameNS(&quot;*&quot;, &quot;LineString&quot;);
            
            //Parse the geometry we found into map primitives
            for (var geomIndex = 0; geomIndex &lt; polygonNodes.length; geomIndex++) {
                mapItem = this.parsePolygon(name, description, polygonNodes[geomIndex],featureNode);
                if (mapItem !== null) {
                    primitives.push(mapItem);
                }
            }
            
            for (var geomIndex = 0; geomIndex &lt; pointNodes.length; geomIndex++) {
                mapItem = this.parsePoint(name, description, pointNodes[geomIndex],featureNode);
                if (mapItem !== null) {
                    primitives.push(mapItem);
                }
            }
            
            for (var geomIndex = 0; geomIndex &lt; lineStringNodes.length; geomIndex++) {
                mapItem = this.parseLineString(name, description, lineStringNodes[geomIndex],featureNode);
                if (mapItem !== null) {
                    primitives.push(mapItem);
                }
            }
        }

        return primitives;
    };
   
     
}]);
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
